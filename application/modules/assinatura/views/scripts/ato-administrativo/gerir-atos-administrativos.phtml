<main>
    <?php
    $links = array(
        array('Gerir Atos Administrativos' => array())
    );
    ?>
    <div class="content padding20 clearfix">

        <script type="text/javascript">
            $3(document).ready(function () {
                carregarOpcoesComboAjax('#idTipoDoAto', callbackCarregarOrdemAssinatura());
                carregarOpcoesComboAjax('#idCargoDoAssinante', callbackCarregarOrdemAssinatura());

                $3('#idOrgaoSuperiorDoAssinante').change(function() {
                    callbackOrgaoSuperior();
                });
                carregarOpcoesComboAjax('#idOrgaoSuperiorDoAssinante', callbackOrgaoSuperior);
                carregarOpcoesComboAjax('#idPerfilDoAssinante', callbackCarregarOrdemAssinatura());
            });

            function callbackCarregarOrdemAssinatura(){
                var parametrosOrdem = {
                    idOrgaoSuperiorDoAssinante: $3('#idOrgaoSuperiorDoAssinante').find('option:selected').val(),
                    idTipoDoAto: $3('#idTipoDoAto').find('option:selected').val(),
                    idOrdemDaAssinatura: $3('#idOrdemDaAssinatura').find('option:selected').val()
                };
console.log(parametrosOrdem);
                $3('#idOrdemDaAssinatura').data('parametros', parametrosOrdem);
                if(parametrosOrdem.idOrgaoSuperiorDoAssinante
                    && parametrosOrdem.idTipoDoAto
                ) {
                    carregarOpcoesComboAjax('#idOrdemDaAssinatura');
                }
            }

            function callbackOrgaoSuperior() {
                var parametrosOrgaos = {
                    idOrgaoSuperiorDoAssinante: $3('#idOrgaoSuperiorDoAssinante').find('option:selected').val()
                };
                $3('#idOrgaoDoAssinante').data('parametros', parametrosOrgaos);
                carregarOpcoesComboAjax('#idOrgaoDoAssinante', callbackCarregarOrdemAssinatura());
            }

            function carregarOpcoesComboAjax(seletorSelect, callback) {
                $3('select').material_select('destroy');
                var parametros = {};
                if($3(seletorSelect).data('parametros')) {
                    parametros = $3(seletorSelect).data('parametros');
                }

                $3.get(
                    $3(seletorSelect).data('link'),
                    parametros,
                    function (data) {
                        $3(seletorSelect).html('');
                        for (var indice in data.resultado) {
                            var itemSelecionao = (data.resultado[indice].codigo == $(seletorSelect).data('valorSelecionado')) ? "selected='selected' " : '';
                            $3(seletorSelect).append(
                                "<option value='"
                                + data.resultado[indice].codigo
                                + "'"
                                + itemSelecionao
                                + ">"
                                + data.resultado[indice].descricao
                                + "</option>"
                            );
                        }
                        $3('select').material_select();
                        if(callback) {
                            callback.call(this);
                        }
                    }
                );

            }
        </script>
        <div>
            <div class="row">
                <form class="col s12">
                    <div class="row">
                        <div class="input-field col s12">
                            <h3><span id="acao">Cadastrar</span> Ato Administrativo</h3>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <input type="hidden" id="idAtoAdministrativo"/>
                            <select id="idTipoDoAto"
                                    data-link="<?php echo $this->url(array(
                                            'module' => 'assinatura',
                                            'controller' => 'ato-administrativo',
                                            'action' => 'obter-tipos-de-atos-administrativos-ajax'
                                        )) ?>">
                            </select>
                            <label>Tipo do Ato Administrativo</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <select id="idCargoDoAssinante"
                                    data-link="<?php echo $this->url(array(
                                        'module' => 'assinatura',
                                        'controller' => 'ato-administrativo',
                                        'action' => 'obter-cargos-do-assinante-ajax'
                                    )) ?>">
                            </select>
                            <label>Cargo do Assinante</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <select id="idOrgaoSuperiorDoAssinante"
                                    data-link="<?php echo $this->url(array(
                                        'module' => 'assinatura',
                                        'controller' => 'ato-administrativo',
                                        'action' => 'obter-orgaos-superiores-ajax'
                                    )) ?>"></select>
                            <label>Org&atilde;o Superior do Assinante</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <select id="idOrgaoDoAssinante"
                                    data-link="<?php echo $this->url(array(
                                        'module' => 'assinatura',
                                        'controller' => 'ato-administrativo',
                                        'action' => 'obter-orgaos-do-assinante-ajax'
                                    )) ?>"></select>
                            <label>Org&atilde;o do Assinante</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <select id="idPerfilDoAssinante"
                                    data-link="<?php echo $this->url(array(
                                        'module' => 'assinatura',
                                        'controller' => 'ato-administrativo',
                                        'action' => 'obter-perfis-do-assinante-ajax'
                                    )) ?>"></select>
                            <label>Perfil do Assinante</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <select id="idOrdemDaAssinatura"
                                    data-link="<?php echo $this->url(array(
                                        'module' => 'assinatura',
                                        'controller' => 'ato-administrativo',
                                        'action' => 'obter-ordem-assinatura-ajax'
                                    )) ?>"></select>
                            <label>Ordem da Assinatura</label>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="row">
            <div class="col s10">
                <?php gerarBreadCrumb($links); ?>
            </div>
        </div>
        <div class="row">
            <div class="col s12">
                <input type="hidden" id="idTipoDoAtoAdministrativo" name="idTipoDoAtoAdministrativo"/>
                <table class="bordered margin0" id="enquadramento">
                    <thead>
                    <tr class="">
                        <th class="center-align">Ato Administrativo</th>
                        <th class="center-align">Cargo</th>
                        <th class="center-align">Orgao</th>
                        <th class="center-align">Perfil</th>
                        <th class="center-align" align="center" colspan="2">A&ccedil;&atilde;o</th>
                    </tr>
                    </thead>
                    <tbody>
                    <?php foreach ($this->atosAdministrativos as $dado): ?>
                        <tr>
                            <td class="center-align" align="center">
                                <!--                                    --><?php //xd($this->atosAdministrativos); ?>
                                <?php echo $dado['dsAtoAdministrativo']; ?></td>
                            <td class="center-align" align="center"><?php echo $dado['dsCargoDoAssinante']; ?></td>
                            <td class="center-align" align="center"><?php echo $dado['dsOrgaoDoAssinante']; ?></td>
                            <td class="center-align" align="center"><?php echo $dado['dsPerfil']; ?></td>
                            <td class="center-align" align="center">
                                <?php
                                $parametrosVisualicacao = "?idAtoAdministrativo={$dado['idAtoAdministrativo']}";
                                ?>
                                <a class="btn waves-effect waves-light tooltipped small "
                                   href="<?php echo $this->url(array(
                                           'module' => 'assinatura',
                                           'controller' => 'ato-administrativo',
                                           'action' => 'alterar'
                                       )) . $parametrosVisualicacao ?>"
                                   data-position="top"
                                   data-delay="50"
                                   data-tooltip="Alterar">
                                    <i class="material-icons">border_color</i>
                                </a>
                            </td>
                            <td class="center-align" align="center">
                                <?php
                                $parametrosVisualicacao = "?idAtoAdministrativo={$dado['idAtoAdministrativo']}";
                                ?>
                                <a class="btn waves-effect waves-light tooltipped small "
                                   href="<?php echo $this->url(array(
                                           'module' => 'assinatura',
                                           'controller' => 'ato-administrativo',
                                           'action' => 'remover'
                                       )) . $parametrosVisualicacao ?>"
                                   data-position="top"
                                   data-delay="50"
                                   data-tooltip="Remover">
                                    <i class="material-icons">delete</i>
                                </a>
                            </td>
                        </tr>
                    <?php endforeach; ?>
                    </tbody>
                </table>
                <div class="center-align" id="divAssinaturaEmMassa"
                     style="display: none;">
                    <button class="btn waves-effect waves-light" type="submit" name="action">
                        Assinar em massa <i class="material-icons right">send</i>
                    </button>
                </div>

            </div>
        </div>
    </div>

    <div id="conteudoDialogoModal">

        <div id="modalConfirmacao" class="modal modal-fixed-footer">
            <div class="modal-content">
                <h4>Confirma&ccedil;&atilde;o</h4>
                <p>Tem certeza que deseja movimentar ao projeto <span class="bold" id="nrPronacConfirmacao"></span> ?
                </p>
            </div>
            <div class="modal-footer">
                <a href="#!" id="botaoConfirmacaoEncaminhamento"
                   class="modal-action modal-close waves-effect waves-green btn-flat">Sim</a>
                <a href="#!" class="modal-action modal-close waves-effect waves-red btn-flat">N&atilde;o</a>
            </div>
        </div>
    </div>


    <script>
        $3(document).ready(function () {
            $3('.modal').modal({
                    dismissible: true,
                    opacity: .5,
                    inDuration: 300,
                    outDuration: 200,
                    startingTop: '4%',
                    endingTop: '10%',
                    ready: function (modal, trigger) {
                        $(modal).find('#nrPronacConfirmacao').html($3(trigger).data('nrpronac'));
                        $(modal).find('#botaoConfirmacaoEncaminhamento').attr('href', $3(trigger).data('redirectUrl'));
                    }
//                    ,complete: function() {
//                        alert('Closed');
//                    } // Callback for Modal close
                }
            );
        });
    </script>

    <br clear="all"/>
    <script src="https://code.jquery.com/jquery-1.12.4.js"
            integrity="sha256-Qw82+bXyGq6MydymqBxNPYTaUXXq7c8v3CwiYwLLNXU="
            crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.12/datatables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.13/js/dataTables.material.min.js"></script>

    <script type="text/javascript">
        (function ($) {

            $(document).ready(function () {
                $('#enquadramento').DataTable({
                    "language": {
                        "url": "https://cdn.datatables.net/plug-ins/1.10.12/i18n/Portuguese-Brasil.json"
                    }
                    , "order": [0, 1]
                    , "searching": true
                    , "lengthChange": true
                    , columnDefs: [{
                        targets: [0, 1],
                        className: 'mdl-data-table__cell--non-numeric'
                    }]
                    ,
                    "aoColumnDefs": [
                        {'bSortable': false, 'aTargets': [0, 1, 2, 3]}
                    ]
                });
                $3("#marcarDesmarcarCheckboxLabel").click(function () {
                    utilitarios.marcarDesmarcarCheckBoxesMaterialize($3("#marcarDesmarcarCheckbox"), ".checkbox_legal");
                    tratarExibicaoCheckboxChecados('.checkbox_legal', '#divAssinaturaEmMassa');
                });

                function tratarExibicaoCheckboxChecados(seletorCheckboxes, seletorExibicao) {
                    var quantidadeCheckboxChecados = $(seletorCheckboxes).filter(':checked').length;
                    if (quantidadeCheckboxChecados > 0) {
                        $3(seletorExibicao).show('fast');
                    } else {
                        $3(seletorExibicao).hide('fast');
                    }
                }

                $3('.checkbox_legal').click(function () {

                    var quantidadeCheckBoxesSelecionados = $('.checkbox_legal').filter(':checked').length;
                    var isCheckBoxAtualSelecionado = ($(this).filter(':checked').length > 0);

                    if (quantidadeCheckBoxesSelecionados == 1) {
                        $("#idTipoDoAtoAdministrativo").val($(this).data('idtipoatoadministrativo'))
                    } else if (quantidadeCheckBoxesSelecionados > 1) {
                        if (isCheckBoxAtualSelecionado && $(this).data('idtipoatoadministrativo') != $("#idTipoDoAtoAdministrativo").val()) {
                            Materialize.toast("O Encaminhamento em massa só é permitido para projetos com o mesmo Tipo de Ato Administrativo.", 4000);
                            $(this).trigger('click');
                        }
                    } else {
                        $("#idTipoDoAtoAdministrativo").val(null);
                    }

                    tratarExibicaoCheckboxChecados('.checkbox_legal', '#divAssinaturaEmMassa');
                });

                $3("#formGerenciamentoPropostas").validate({
                    rules: {
                        marcarDesmarcarCheckbox: {
                            validarPreenchimento: true
                        }
                    },
                    messages: {
                        marcarDesmarcarCheckbox: {
                            validarPreenchimento: ""
                        }
                    },

                    submitHandler: function (form) {
                        $3("#container-progress").show();
                        form.submit();
                    },
                    invalidHandler: function (event, validator) {
                        Materialize.toast("Selecione um item.", 4000);
                    }
                });

                $3.validator.addMethod("validarPreenchimento", function (value, element) {
                    var checkbox = $('input[type=checkbox]:checked').filter('.checkbox_legal');
                    if (checkbox.length > 0) {
                        return true;
                    }
                });
            });
        }($.noConflict(true)));
    </script>
</main>