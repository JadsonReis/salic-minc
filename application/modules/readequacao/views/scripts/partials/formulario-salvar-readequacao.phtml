<form name="formReadequacao"
      id="formReadequacao"
      action="<?php echo $this->url(
          [
              'module' => 'readequacao',
              'controller' => 'readequacoes',
              'action' => 'incluir-solicitacao-readequacao'
          ], null, true); ?><?php echo '?idPronac=' . Seguranca::encrypt($this->idPronac); ?>"
      method="post"
      enctype="multipart/form-data">
    <input type="hidden" id="idReadequacao" name="idReadequacao"
           value="<?php echo $this->readequacao->idReadequacao; ?>">
    <input type="hidden" id="pertenceIn2017" name="pertenceIn2017" value="<?php echo $this->in2017; ?>">
    <input type="hidden" id="tipoReadequacao" name="tipoReadequacao" value="<?php echo $this->idTipoReadequacao; ?>">
    <input type="hidden" id="urlCallback" name="urlCallback" value="<?php echo $this->urlCallback; ?>">
    <div class="row">
        <div class="col s12">
            <span>Justificativa da Solicita&ccedil;&atilde;o </span><span class="red-text">*</span>
            <textarea cols="80" class="editor" id="descJustificativa" name="descJustificativa" rows="10">
                <?php echo $this->readequacao->dsJustificativa; ?>
            </textarea>
        </div>

        <div class="row">
            <div class="col s12">
                <div id="anexarDocumento" class="card-panel">

                    <?php if ($this->readequacao->idArquivo): ?>
                        <label for="arquivo" style="width: 100px; ">Anexar arquivo: </label>
                        <span id="file_name"
                              style="margin-right:20px "><?= utf8_decode(htmlentities($this->dataForm['arquivo']['nmArquivo'])); ?></span>
                        <a class="waves-effect waves-light btn tooltipped" id="file_upload" data-position="top"
                           data-delay="50" data-tooltip="Upload" href="#"><i class="tiny material-icons">file_upload</i></a>
                        <a class="waves-effect waves-light btn tooltipped" data-position="top" data-delay="50"
                           data-tooltip="Download" href="<?= $this->url(
                            array('module' => 'default', 'controller' => 'upload', 'action' => 'abrir'), null, true); ?>?id=<?= $this->readequacao->idArquivo; ?>"><i
                                class="tiny material-icons">file_download</i></a>
                        <a class="waves-effect waves-light btn  red darken-4 tooltipped" data-position="top"
                           data-delay="50" data-tooltip="Excluir" href="#" id="file_delete"><i
                                class="tiny material-icons">delete_forever</i></a>
                        <input type="file" name="arquivo" id="arquivo" class="hiddenfile">
                    <?php else: ?>
                        <label for="arquivo" style="width: 100px; ">Anexar arquivo: </label>
                        <input type="file" name="arquivo" id="arquivo" class="input_simples">
                    <?php endif; ?>

                    <div id="arquivoinvalido" style="color:#FF0000"></div>
                </div>
            </div>
        </div>

        <table class="tabela solicitacoesSimples sumir">
            <tr>
                <td class="destacar bold" style="font-size: 13px;">Anexo</td>
            </tr>
            <?php if (count($this->readequacao) > 0): ?>
                <?php if (!empty($this->readequacao->idArquivo)): ?>
                    <tr>
                        <td>
                            <a href="<?php echo $this->url(array('module' => 'default', 'controller' => 'upload', 'action' => 'abrir')); ?>?id=<?php echo $this->readequacao[0]->idArquivo; ?>"><?php echo $this->readequacao[0]->nmArquivo; ?></a>
                        </td>
                    </tr>
                <?php endif; ?>
            <?php endif; ?>
            <tr>
                <td><input type="file" name="arquivo" class="input_simples"> <span style="margin-left: 10px;"
                                                                                   class="red-text">Somente arquivos .pdf</span>
                </td>
            </tr>
        </table>

        <div class="col s12">
            <span>Anexo</span><br>
            <input type="file" name="arquivo" class="input_simples">
            <span style="margin-left: 10px;" class="red-text">Somente arquivos .pdf</span>
        </div>
    </div>
    <div class="padding20 center-align">
        <a
            id="IncluirReadequacao" class="waves-effect waves-light btn btn-primary">
            <i class="material-icons right">save</i>Salvar
        </a>
        <a
            href="javascript:void(0)"
            id="btn_finalizar"
            class="waves-effect waves-light btn btn-secondary">
            <i class="material-icons right">send</i>Finalizar
        </a>

        <?php if ($this->readequacao->idReadequacao) : ?>
            <a
                href="javascript:void(0)"
                class="btn waves-effect waves-light btn-danger btn-excluir"
                title="Excluir readequa&ccedil;&atilde;o"
                readequacao="<?php echo $this->readequacao->idReadequacao; ?>"
            > Excluir
                <i class="material-icons right">delete</i>
            </a>
        <?php endif; ?>
    </div>
</form>

<div id="msgAlertaFormulario" class="sumir"></div>

<script type="text/javascript">

    function excluirReadequacao(idReadequacao) {
        window.location = "<?php echo $this->url(array('module' => 'readequacao', 'controller' => 'readequacoes', 'action' => 'excluir-solicitacao-readequacao'), null, true); ?>?idPronac=<?php echo Seguranca::encrypt($this->idPronac); ?>&idReadequacao=" + idReadequacao;
    }

    $(document).ready(function () {

        $("textarea.editor").each(function () {
            $(this).editorRico({
                altura: 200,
                maxchar: 5000,
                isLimitarCarateres: true,
                isDesabilitarEdicao: 0
            });
        });

        $('#IncluirReadequacao').click(function () {
            if (typeof tinyMCE == 'object') {
                tinyMCE.triggerSave();
            }

            var descJustificativa = $('#descJustificativa').val().toString().replace(/(<.*?>)|(&nbsp;)|(\s+)/g, ''),
                texto = $('#descJustificativa').val(),
                erro = 0,
                msg = 'Favor preencher os dados obrigat&oacute;rios!',
                tipoRead = $('#tipoReadequacao').val(),
                solicitacoesSimples = new Array(3, 4, 5, 6, 7, 8, 10, 11, 12, 13, 15, 16, 17, 18, 19, 20, 21),
                solicitacoesSimplesCKEditor = new Array(5, 6, 7, 8, 16, 17, 18, 19, 20, 21),
                naoPedeConfirmacao = new Array(2, 11);

            if (descJustificativa.length <= 1) {
                erro++;
            }

            if (texto.length > 5000) {
                erro++;
                msg = 'O campo s\u00F3 permite 5.000 caracteres!';
            }

            if (in_array(tipoRead, solicitacoesSimples)) {

                if (tipoRead == 15) {
                    var campoRead = CKEDITOR.instances['descSolicitacao'].getData().toString().replace(/(<.*?>)|(&nbsp;)|(\s+)/g, ''),
                        textoSolicitacao = CKEDITOR.instances['descSolicitacao'].getData();
                    if (campoRead == '') {
                        erro++;
                    } else if (textoSolicitacao.length > 1000) {
                        erro++;
                        msg = 'O campo s\u00F3 permite 1.000 caracteres!';
                    }
                }

                if (in_array(tipoRead, solicitacoesSimplesCKEditor)) {
                    var campoRead = CKEDITOR.instances['descSolicitacao'].getData().toString().replace(/(<.*?>)|(&nbsp;)|(\s+)/g, ''),
                        textoSolicitacao = CKEDITOR.instances['descSolicitacao'].getData();
                    if (campoRead == '') {
                        erro++;
                    }
                }
            }

            if (erro > 0) {
                $("#msgAlertaFormulario").dialog("destroy");
                $("#msgAlertaFormulario").html(msg);
                $("#msgAlertaFormulario").dialog({
                    resizable: false,
                    title: 'Alerta!',
                    width: 340,
                    height: 170,
                    modal: true,
                    buttons: {
                        'OK': function () {
                            $(this).dialog('close');
                        }
                    }
                });
                $('.ui-dialog-titlebar-close').remove();
            } else {
                $("#msgAlertaFormulario").dialog("destroy");
                $("#msgAlertaFormulario").html('Deseja incluir essa solicita&ccedil;&atilde;o de readequa&ccedil;&atilde;o?');
                $("#msgAlertaFormulario").dialog({
                    resizable: false,
                    title: 'Alerta!',
                    width: 360,
                    height: 170,
                    modal: true,
                    buttons: {
                        'N\u00E3o': function () {
                            $(this).dialog('close');
                        },
                        'Sim': function () {
                            $(this).dialog('close');
                            $("#msgAlertaFormulario").dialog("destroy");
                            $("#msgAlertaFormulario").html('<br /><div align="center"><img src="<?php echo $this->baseUrl() . '/public/img/ajax.gif'; ?>"><br />Aguarde..</div>');
                            $("#msgAlertaFormulario").dialog({
                                resizable: false,
                                width: 320,
                                modal: true,
                                title: 'Carregando..'
                            });
                            $('.ui-dialog-titlebar-close').remove();
                            $('#formReadequacao').submit();
//                            window.setTimeout('enviarformulario()', 1000);
                        }
                    }
                });
                $('.ui-dialog-titlebar-close').remove();
            }
        });

        $('.btn-excluir').click(function () {
            var idReadequacao = $(this).attr('readequacao');
            $("#msgAlertaFormulario").dialog("destroy");
            $("#msgAlertaFormulario").html('Deseja excluir a solicita&ccedil;&atilde;o de readequa&ccedil;&atilde;o?');
            $("#msgAlertaFormulario").dialog({
                resizable: false,
                title: 'Alerta!',
                width: 360,
                modal: true,
                buttons: {
                    'N\xE3o': function () {
                        $(this).dialog('close');
                    },
                    'Sim': function () {
                        $(this).dialog('close');
                        $("#msgAlertaFormulario").dialog("destroy");
                        $("#msgAlertaFormulario").html('<br /><div align="center"><img src="<?php echo $this->baseUrl() . '/public/img/ajax.gif'; ?>"><br />Aguarde..</div>');
                        $("#msgAlertaFormulario").dialog({
                            resizable: false,
                            width: 320,
                            modal: true,
                            title: 'Carregando..'
                        });
                        $('.ui-dialog-titlebar-close').remove();
                        window.setTimeout('excluirReadequacao(' + idReadequacao + ')', 1000);
                    }
                }
            });
            $('.ui-dialog-titlebar-close').remove();
        });

        function enviarformulario() {
            $('#formReadequacao').submit();
        }
    });
</script>